<!DOCTYPE composition PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
	xmlns:s="http://jboss.com/products/seam/taglib"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:a="http://richfaces.org/a4j"
	xmlns:rich="http://richfaces.org/rich"
	template="/layout/template_edit.xhtml">

	<ui:define name="head">
		<link rel="stylesheet" type="text/css" href="#{request.contextPath}/common/css/bootstrap-datetimepicker.min.css" />
		<link rel="stylesheet" type="text/css" href="#{request.contextPath}/common/css/bootstrap.min.css" />
		<link rel="stylesheet" type="text/css" href="#{request.contextPath}/common/css/bootstrap-select.min.css" />
		<link rel="stylesheet" type="text/css" href="#{request.contextPath}/icheck/skins/square/blue.css" />
		<link rel="stylesheet" type="text/css" href="#{request.contextPath}/stylesheet/fix.css" />
		<link rel="stylesheet" type="text/css" href="#{request.contextPath}/stylesheet/template_list.css" />
		<link rel="stylesheet" type="text/css" href="#{request.contextPath}/sg-fileupload/css/kernel.css" />
		<style type="text/css">
			.bs-w440 .bootstrap-select:not([class*="span"]):not([class*="col-"]):not([class*="form-control"]):not(.input-group-btn) {
			    width: 440px;
			}
			
			.normal-candidateProject .selected {
				background: #da9a48;
			}
			
			.normal-attendProject .root {
				background: #add595;
			}
			
			.node-totalAmount {
				font-weight: bold;
			}
			.border{
			  	border-left:none;
			  	border-left-width:0px;
			    border-right:none;
			    border-right-width:0px;
			  	border-top:none;
			  	border-top-width:0px;
			    border-bottom:1.4px solid rgba(15, 37, 67, 0.22);
			 }
			 .btn-add {
			    color: #fff;
			    background-color: #3c764e;
			    border-color: #ffffff;
			}
			.modal-header-modal {
			    min-height: 7.43px;
			    padding: 0px;
			    border-bottom: 1px solid #e5e5e5;
			}
			.modaltd .bootstrap-select:not([class*="span"]):not([class*="col-"]):not([class*="form-control"]):not(.input-group-btn) {
			    width: 170px;
			}
			.allMoney {
			    float: left;
			    width: 123px;
			    padding-right: 15px;
			    font-family: '微软雅黑';
			    text-align: right
			}
			.icon {
			    background-image: url(../images/glyphicons-halflings.png);
			    background-position: 14px 14px;
			    background-repeat: no-repeat;
			    display: inline-block;
			    height: 14px;
			    line-height: 14px;
			    margin-top: 1px;
			    vertical-align: text-top;
			    width: 14px;
			}
			input{text-align:center}
			
			.mater_name_bd{
				position:absolute;
				min-width:200px;
				display:none;
				top:212px;
				width:220px;
				border:1px solid #ddd;
				box-sizing:border-box;
				background-color:#fff;
				text-align:left;
				font-size:12px;
				}
			.mater_name_list{
				height:77px;
				overflow:auto;
				}
			.mater_name_list li{
				height:24px;
				line-height:24px;
				padding:0 10px;
				cursor:pointer;
				white-space:nowrap;
				list-style-type:none;
				
				margin: 2px;
				}
			.mater_name_list li.m_cur{
				background-color:#f4f4f4;
				}
			.mater_name_list li:hover{
				color:#C0C0C;
				}
			.addbg{
			        background:#87A900;
			    }
			    
			.modal-footer{
				border: none;
			}
			.g-data-list-table-custom {
			        width: 100%;
				    min-height: 186px;
				    font-family: '微软雅黑';
				    color: #333333;
				    position: relative;
				    padding: 0 15px;
				    box-sizing: border-box;
			}
			.g-data-list-table-custom .record th,.g-data-list-table .record tbody td {
				height: 38px;
				text-align: center;
				border-bottom: 1px solid #e1e1e1;
			}
			
			.g-data-list-table-custom .record th {
				height: 42px;
				background: f9f9f9;
				font-size: 12px;
				font-weight: normal;
			}
			
			.g-data-list-table-custom .record th:first-child {
				border-radius: 10px 0 0 0;
			}
			
			.g-data-list-table-custom .record th:last-child {
				border-radius: 0 10px 0 0;
			}
			
			.g-data-list-table-custom .record tr.node-record.odd td {
				background: #F7F7F7;
			}
			
			.g-data-list-table-custom .record tr.node-record.even td {
				background: #F5FFFA;
			}
			
			.g-data-list-table-custom .record tr.node-record:hover td {
				/* background: #86CEF0; */
			}
		</style>
	</ui:define>
	<ui:define name="body">
	#{expendApplyInfoHome.wire()}
		<h:form id="mainForm" styleClass="edit" enctype="multipart/form-data">
			<div class="pd0-10">
				<div style="padding-top: 22px;">
					<h:inputHidden id="projectJson" value="#{expendApplyInfoHome.projectJson}" />
					<table class="normal-btn">
						<tr>
							<td>
								<s:fragment rendered="#{expendApplyInfoHome.expendApplyInfoId eq null or expendApplyInfoHome.expendApplyInfoId eq 0}">
									<a class="btn btn-primary mr15" onclick="return checkSub();">提交</a>
								</s:fragment>
								<s:fragment rendered="#{expendApplyInfoHome.expendApplyInfoId ne null and expendApplyInfoHome.expendApplyInfoId ne 0}">
									<a class="btn btn-primary mr15" onclick="return checkEdit();">提交</a>
								</s:fragment>
								<s:button id="cancel" value="返回" view="/budget/ExpendApplayList.xhtml" propagation="none" styleClass="btn btn-default" />
							</td>
						</tr>
					</table>
					<br />
					<br />
				</div>
				<div class=" fs14">
				<h:inputHidden value="#{expendApplyInfoHome.expendApplyInfoId}" id="expendApplyIdEdit"/>
					<table width="100%" cellpadding="0" cellspacing="0">
						<tr>
							<td width="50%">
								<div class="pb6">
									<table>
										<tr>
											<td valign="middle">
												<span class="field-name mb10">预算年份:</span>
											</td>
											<td valign="middle">
												<select id="budgetYear" class="selectpicker">
													<a:repeat value="#{expendApplyInfoHome.budgetYearList}" var="_var">
														<s:fragment rendered="#{expendApplyInfoHome.year eq _var[0]}" >
															<option value="#{_var[0]}" selected="selected">#{_var[1]}</option>
														</s:fragment>
														<s:fragment rendered="#{expendApplyInfoHome.year ne _var[0]}" >
															<option value="#{_var[0]}" >#{_var[1]}</option>
														</s:fragment>
													</a:repeat>
												</select>
											</td>
											<td valign="middle">
												<font color="red" style="margin-left: 3px;">*</font>
											</td>
											
										</tr>
									</table>
								</div>
							</td>
							<td width="50%">
								<div class="pb6">
									<table>
										<tr>
											<td valign="middle">
												<span class="field-name mb10">申请人:</span>
											</td>
											<td valign="middle">
												<select id="user" class="selectpicker" data-live-search="true">
													<a:repeat value="#{expendApplyInfoHome.applayUserList}" var="_department">
														<optgroup label="#{_department[0]}" data-subtext="科室">
															<a:repeat value="#{_department[1]}" var="_user">
																<s:fragment rendered="#{sessionToken.userInfoId eq _user[0]}">
																	<option value="#{_user[0]}" selected="selected">#{_user[1]}</option>
																</s:fragment>
																<s:fragment rendered="#{sessionToken.userInfoId ne _user[0]}">
																	<option value="#{_user[0]}" >#{_user[1]}</option>
																</s:fragment>
															</a:repeat>
														</optgroup>
													</a:repeat>
												</select>
											</td>
											<td valign="middle">
												<font color="red" style="margin-left: 3px;">*</font>
											</td>
										</tr>
									</table>
								</div>
							</td>
						</tr>
						<tr>
							<td width="50%">
								<div class="pb6">
									<table>
										<tr>
											<td valign="middle">
												<span class="field-name mb10">单据编号:</span>
											</td>
											<td valign="middle">
												<h:inputText id="formnum" readonly="readonly" value="#{expendApplyInfoHome.applySn}" styleClass=" mb10 border" style="height:34px;width:220px" maxlength="20" />
											</td>
											<td valign="middle">
												<font color="red" style="margin-left: 3px;">*</font>
											</td>
										</tr>
									</table>
								</div>
							</td>
							<td width="50%">
								<div class="pb6">
									<table>
										<tr>
											<td valign="middle">
												<span class="field-name mb10">报销人姓名:</span>
											</td>
											<td valign="middle">
												<h:inputText id="reimbur" value="#{expendApplyInfoHome.reimbur}" styleClass=" mb10 border" style="height:34px;width:220px" maxlength="20"/>
											</td>
											<td valign="middle">
												<font color="red" style="margin-left: 3px;">*</font>
											</td>
										</tr>
									</table>
								</div>
							</td>
						</tr>
						<tr>
							<td width="50%">
								<div class="pb6">
									<table>
										<tr>
											<td valign="middle">
												<span class="field-name mb10">收款单位:</span>
											</td>
											<td valign="middle">
												<!-- <h:inputText id="reciveCompany" value="#{expendApplyInfoHome.reciveCompany}" styleClass=" mb10 border" style="height:34px;width:395px" maxlength="100" onkeyup='searchLi(this,event,1)' onblur="searchDis(this)"/> -->
												<!-- <h:inputText id="reciveCompany" value="#{expendApplyInfoHome.reciveCompany}" styleClass=" mb10 border" style="height:34px;width:395px" maxlength="100"  onblur="companyBlur()" onfocus="companyFous()"/> -->
												<input id="reciveCompany" value="#{expendApplyInfoHome.reciveCompany}" class=" mb10 border" style="height:34px;width:395px" maxlength="100"  placeholder="报销论文版面费请添加科室+杂志名称" onkeyup='searchLi(this,event,1)' onblur="searchDis(this)"/>
												<div class="mater_name_bd"  style="min-width: 10%;z-index:9999;width: 395px;" >
			                                    	<ul class="mater_name_list"  style="padding-left: 0; width: 395px;">
			                                       		<a:repeat value="#{expendApplyInfoHome.companyList}" var="_com" rowKeyVar="_row">
			                                       			<li name="companyLi" onclick="clickSearch(this)" class="material_li material_li_#{_row + 1}" >#{_com}</li>
			                                       		</a:repeat>
			                                        </ul>
			                                        <ul class='mater_name_list3'  style='display:none;width: 395px;'>
			                                        	<a:repeat value="#{expendApplyInfoHome.companyList}" var="_company" rowKeyVar="_r">
			                                       			<li name="companyLi" onclick="clickSearch(this)" class="material_li_#{_r + 1}">#{_company}</li>
			                                       		</a:repeat>
			                                        </ul>
			                                    </div>
											</td>
											<td valign="middle">
												<font color="red" style="margin-left: 3px;">*</font>
											</td>
										</tr>
									</table>
								</div>
							</td>
							<td width="50%">
								<div class="pb6">
									<table>
										<tr>
											<td valign="middle">
												<span class="field-name mb10">发票张数:</span>
											</td>
											<td valign="middle">
												<h:inputText id="summary" value="#{expendApplyInfoHome.summary}" styleClass=" mb10 border" style="height:34px;width:220px" maxlength="20"/>
											</td>
											<td valign="middle">
											</td>
										</tr>
									</table>
								</div>
							</td>
						</tr>
						<tr>
							<td width="100%">
								<div class="pb6">
									<table>
										<tr>
											<td valign="middle">
												<span class="field-name mb10">发票号&nbsp;&nbsp;:</span>
											</td>
											<td valign="middle">
												<!-- <h:inputText id="invoicenum" value="#{expendApplyInfoHome.invoiceSn}" styleClass=" mb10 border" style="height:34px;width:395px" maxlength="300"/> -->
												<h:inputTextarea value="#{expendApplyInfoHome.invoiceSn}" id="invoicenum"  styleClass=" mb10 border" style="width:395px"/>
											</td>
											<td valign="middle">
											</td>
										</tr>
									</table>
								</div>
							</td>
							<td width="50%">
								<div class="pb6">
									
								</div>
							</td>
						</tr>
					</table>
				</div>
				<div style="height: 43px;">
					<a class="btn btn-add mr15" onclick="toAddModel()" style="float:right ">添加</a>
				</div>
				<rich:panel id="listPanl" style="margin:0; border:none; padding: 0;">
				<div class="g-data-list-table-custom freeze-candidateProject" style="border: 1px solid #e1e1e1;height:200px;overflow:auto;">
				    <table class="record" width="100%" cellpadding="0" cellspacing="0">
				        <tr>
				        	<th width="5%">序号</th>
				            <th width="15%">项目名称</th>
				            <th width="10%">资金来源</th>
				            <th width="13%">年预算金额</th>
				            <th width="13%">已支出金额</th>
				            <th width="13%">可支出金额</th>
				            <th width="13%">本次预算内支出</th>
				            <th width="13%">附件</th>
				            <th width="5%">操作</th>
				            <th style="display:none">id</th>
				        </tr>
				    <a:repeat value="#{expendApplyInfoHome.expendList}" var="_obj" rowKeyVar="_index">
				        <tr class="root expendtr" style="font-size: 14px;font-weight: normal;">
				        	<td style="text-align: center;">#{_index + 1}</td>
				            <td class="project_name" style="text-align: center;">#{_obj[0]}</td>
				            <td style="text-align: center;">#{_obj[5]}</td>
				            <td style="text-align: center;">
				            	<h:outputText value="#{_obj[1]}">
				            	<f:convertNumber pattern="#.00"/>
				            	</h:outputText>
			            	</td>
				            <td style="text-align: center;" id="projectFrozen_#{_index}">
				            	<h:outputText value="#{_obj[2]}">
				            		<f:convertNumber pattern="#.00"/>
				            	</h:outputText>
				            </td>
				            <td  style="text-align: center;" name="canUseMoney" id="canUseMoney_#{_index}">
				            	<h:outputText value="#{_obj[3]}">
				            		<f:convertNumber pattern="#.00"/>
				            	</h:outputText>
			            	</td>
				             <td style="text-align: center;">
				            	<input id="money_#{_index}" name="money" class="form-control row-text-simplify" value="#{numberUtil.double2Str(_obj[4])}" type="text" onblur="totalMoney()"/>
				            </td>
				            <td style="text-align: center;">
				            	<span id="attachment_#{_index}" class="operation-item opr-attachment"  fu-source="#{_obj[9]}" style="cursor:pointer;#{_obj[9] ne null and _obj[9] ne '' ? 'color:blue' : ''}">附件</span>
				            </td>
				            <td style="text-align: center;">
				            	<a name="delete" title="删除" style="text-decoration: none; cursor: pointer;" onclick="deleteList()">
									<img src="../images/icon_delete_16x16.png"/>
								</a>
							</td>
				            <td style="display:none" id="project_id_#{_index}">#{_obj[7]}</td>
				            <td style="display:none" id="project_type_#{_index}">#{_obj[8]}</td>
				            <td style="display:none" id="nepi_id_#{_index}">#{_obj[10]}</td>
				        </tr>
				   	</a:repeat>
				    </table>
				</div>
				</rich:panel>
				<div class="pt30 pb30 fs14">
					<table width="100%" cellpadding="0" cellspacing="0">
						<tr>
							<td width="50%">
								<div class="pb20">
									<table>
										<tr>
											<td valign="middle">
												<span class="allMoney">单据总金额:</span>
											</td>
											<td valign="middle">
												<h:inputText id="allMoney" value="#{expendApplyInfoHome.expendAllMoney}" styleClass=" border" style="height:34px;width: 100px;" maxlength="20"  readonly="readonly"/>
											</td>
											<td valign="middle">
												<span class="allMoney mb10">申请时间:</span>
											</td>
											<td valign="middle">
												<div class="input-append date form_datetime_second" style="position:relative;" >
				                               		<input id="applyTime" type="text" value="#{expendApplyInfoHome.applyTime}" readonly="readonly" class = "border" style="width:110px;height:34;" /> 
				                               		<span class="add-on" style="position:absolute; right:10px; top:3px;background-image: url(../images/glyphicons-halflings.png);"><i class="icon-th" style="margin:0;background-image: url(../images/glyphicons-halflings.png);"></i></span>
				                               	</div>
											</td>
											<td valign="middle">
												<font color="red" style="margin-left: 3px;">*</font>
											</td>
										</tr>
									</table>
								</div>
							</td>
							<td width="50%">
								<div class="pb20">
									<table>
										<tr>
											<td valign="middle">
												<span class="allMoney mb10">登记时间:</span>
											</td>
											<td valign="middle">
												<div class="input-append date form_datetime_second" style="position:relative;" >
				                               		<input id="registeTime" type="text" value="#{expendApplyInfoHome.registTime}" readonly="readonly" class = "border" style="width:110px;height:34;" /> 
				                               		<span class="add-on" style="position:absolute; right:10px; top:3px;background-image: url(../images/glyphicons-halflings.png);"><i class="icon-th" style="margin:0;background-image: url(../images/glyphicons-halflings.png);"></i></span>
				                               	</div>
											</td>
											<td valign="middle">
												<span class="allMoney mb10">登记人:</span>
											</td>
											<td valign="middle">
												<select id="register" class="selectpicker" data-live-search="true">
													<a:repeat value="#{expendApplyInfoHome.applayUserList}" var="_department">
														<optgroup label="#{_department[0]}" data-subtext="科室">
															<a:repeat value="#{_department[1]}" var="_user">
																<s:fragment rendered="#{sessionToken.userInfoId eq _user[0]}">
																	<option value="#{_user[0]}" selected="selected">#{_user[1]}</option>
																</s:fragment>
																<s:fragment rendered="#{sessionToken.userInfoId eq _user[0]}">
																	<option value="#{_user[0]}">#{_user[1]}</option>
																</s:fragment>
															</a:repeat>
														</optgroup>
													</a:repeat>
												</select>
											</td>
										</tr>
									</table>
								</div>
							</td>
						</tr>
					</table>
					<div class="pb20">
						<table width="100%" cellpadding="0" cellspacing="0">
							<tr>
								<td width="10%" valign="middle">
									<span class="allMoney ">备注:</span>
								</td>
								<td valign="middle">
									<div>
										<h:inputTextarea value="#{expendApplyInfoHome.comment}"  id="comment"  rows="8" cols="70"/>
									</div>
								</td>
							</tr>
						</table>
					</div>
				</div>
				<!-- <div class="pb95" >
					<h:inputHidden id="projectJson" value="#{expendApplyInfoHome.projectJson}" />
					<table class="normal-btn">
						<tr>
							<td>
								<s:fragment rendered="#{expendApplyInfoHome.expendApplyInfoId eq null or expendApplyInfoHome.expendApplyInfoId eq 0}">
									<a class="btn btn-primary mr15" onclick="return checkSub();">提交</a>
								</s:fragment>
								<s:fragment rendered="#{expendApplyInfoHome.expendApplyInfoId ne null and expendApplyInfoHome.expendApplyInfoId ne 0}">
									<a class="btn btn-primary mr15" onclick="return checkEdit();">提交</a>
								</s:fragment>
								<s:button id="cancel" value="返回" view="/budget/ExpendApplayList.xhtml" propagation="none" styleClass="btn btn-default" />
							</td>
						</tr>
					</table>
					<br />
					<br />
				</div> -->
			</div>
		</h:form>
		<div class="modal fade" id="addModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
		<div class="modal-dialog pano_dialog add_dialog ">
		<div class="modal-content" style="width: 600px;height: 550px;font-size: 13px;">
		    <div class="modal-header-modal clear" style="font-size: 13px;">
		        <h4 style="margin-left: 15px;" >选择项目</h4>
		        <i class="i_close" data-dismiss="modal"></i>
		    </div>
		    <div class="modal-body modal_body">
		    	<table width="550px" cellpadding="0" cellspacing="0">
					<tr>
						<td width="50%">
							<div class="pb20">
								<table>
									<tr>
										<td valign="middle">
											<span class="field-name mb10" style="width:78px">报销部门:</span>
										</td>
										<td valign="middle" class="modaltd">
										<rich:panel id="departPanl" style="margin:0; border:none; padding: 0;">
											<select id="depart" class="selectpicker" data-live-search="true" onchange="departChange()">
												<a:repeat value="#{expendApplyInfoHome.departmentInfoList}" var="_var">
													<s:fragment rendered="#{expendApplyInfoHome.departmentId eq _var[0]}">
														<option value="#{_var[0]}" selected="selected">#{_var[1]}</option>
													</s:fragment>
													<s:fragment rendered="#{expendApplyInfoHome.departmentId ne _var[0]}">
														<option value="#{_var[0]}">#{_var[1]}</option>
													</s:fragment>
												</a:repeat>
											</select>
										</rich:panel>
										</td>
										<td valign="middle">
											<font color="red" style="margin-left: 3px;">*</font>
										</td>
									</tr>
								</table>
							</div>
						</td>
						<td width="50%">
							<div class="pb20">
								<table>
									<tr>
										<td valign="middle">
											<span class="field-name mb10" style="width:78px">资金来源:</span>
										</td>
										<td valign="middle" class="modaltd">
										<rich:panel id="fundsSourcePanl" style="margin:0; border:none; padding: 0;">
											<select id="fundsSource" class="selectpicker" data-live-search="true" onchange="fundsSource()">
													<option value="-1" selected="selected">请选择</option>
												<a:repeat value="#{expendApplyInfoHome.fundsSourceList}" var="_fundsSource">
													<s:fragment rendered="#{expendApplyInfoHome.fundsSourceId eq _fundsSource[0]}">
														<option value="#{_fundsSource[0]}" selected="selected">#{_fundsSource[1]}</option>
													</s:fragment>
													<s:fragment rendered="#{expendApplyInfoHome.fundsSourceId ne _fundsSource[0]}">
														<option value="#{_fundsSource[0]}">#{_fundsSource[1]}</option>
													</s:fragment>
												</a:repeat>
											</select>
										</rich:panel>
										</td>
										<td valign="middle">
											<font color="red" style="margin-left: 3px;">*</font>
										</td>
									</tr>
								</table>
							</div>
						</td>
					</tr>
					<tr>
						<td width="50%">
							<div class="pb20">
								<table>
									<tr>
										<td valign="middle">
											<span class="field-name mb10" style="width:78px">项目类型:</span>
										</td>
										<td valign="top" class="modaltd">
											<rich:panel id="projectTypeSel" style="margin:0; border:none; padding: 0;">
												<select id="projectType" class="selectpicker" onchange="fundsSource()">
													<!-- <option value="2" class="0">项目</option>
													<option value="1" class="0">常规项目</option> -->
													
													<s:fragment rendered="#{expendApplyInfoHome.projectTypeList ne null and expendApplyInfoHome.projectTypeList.size() gt 0}">
														<a:repeat value="#{expendApplyInfoHome.projectTypeList}" var="_pt">
															<option value="#{_pt[0]}">#{_pt[1]}</option>
														</a:repeat>
													</s:fragment>
													<s:fragment rendered="#{expendApplyInfoHome.projectTypeList eq null or expendApplyInfoHome.projectTypeList.size() eq 0}">
														<option value="-1">请选择</option>
													</s:fragment>
												
												</select>
											</rich:panel>
										</td>
										<td valign="middle">
											<font color="red" style="margin-left: 1px;">*</font>
										</td>
									</tr>
								</table>
							</div>
						</td>
					</tr>
					<tr>
						<td width="50%">
							<div class="pb20">
								<table>
									<tr>
										<td valign="middle">
											<span class="field-name mb10" style="width:78px">选择项目:</span>
										</td>
										<td valign="top" class="modaltd">
											<rich:panel id="projectPanl" style="margin:0; border:none; padding: 0;">
												<select id="projectId" class="selectpicker" data-live-search="true" onchange="changeProject()">
													<option value="-1" class="0">请选择</option>
													<a:repeat value="#{expendApplyInfoHome.projectList}" var="_var">
														<s:fragment rendered="#{expendApplyInfoHome.projectId eq _var[1] and expendApplyInfoHome.projectType eq _var[3]}">
															<option value="#{_var[1]}" selected="selected" class = "#{_var[3]}">#{_var[2]}</option>
														</s:fragment>
														<s:fragment rendered="#{expendApplyInfoHome.projectId ne _var[1] or expendApplyInfoHome.projectType ne _var[3]}">
															<option value="#{_var[1]}" class = "#{_var[3]}">#{_var[2]}</option>
														</s:fragment>
													</a:repeat>
												</select>
											</rich:panel>
										</td>
										<td valign="middle">
											<font color="red" style="margin-left: 1px;">*</font>
										</td>
									</tr>
								</table>
							</div>
						</td>
						<td width="50%" style="display:none;" class="contractTr">
							<div class="pb20">
								<table>
									<tr>
										<td valign="middle">
											<span class="field-name mb10" style="width:90px">合同:</span>
										</td>
										<td valign="top" class="modaltd">
										<rich:panel id="contractPanl" style="margin:0; border:none; padding: 0;">
											<select id="contractSel" class="selectpicker" >
												<a:repeat value="#{expendApplyInfoHome.contractList}" var="_var">
													<option value="#{_var[0]}" >#{_var[1]}</option>
												</a:repeat>
											</select>
										</rich:panel>
										</td>
									</tr>
								</table>
							</div>
						</td>

					</tr>
					<tr>
						<td width="50%">
							<div class="pb20">
								<table>
									<tr>
										<td valign="middle">
											<span class="field-name mb10" style="width:90px">已到账金额:</span>
										</td>
										<td valign="middle" class="modaltd">
										<rich:panel id="totalMoneyPanl" style="margin:0; border:none; padding: 0;">
											<input id="totalMoney" value="#{expendApplyInfoHome.totalMoney}" class=" mb10 border" style="height:34px;width:159px;"  readonly="readonly"/>
										</rich:panel>
										</td>
									</tr>
								</table>
							</div>
						</td>
						<td width="50%">
							<div class="pb20">
								<table>
									<tr>
										<td valign="middle">
											<span class="field-name mb10" style="width:90px">已使用金额:</span>
										</td>
										<td valign="top" class="modaltd">
										<rich:panel id="usedMoneyPanl" style="margin:0; border:none; padding: 0;">
											<input id="usedMoney" value="#{expendApplyInfoHome.usedMoney}" class=" mb10 border" style="height:34px;width:159px;"  readonly="readonly"/>
										</rich:panel>
										</td>
									</tr>
								</table>
							</div>
						</td>
					</tr>
					<tr>
						<td width="50%">
							<div class="pb20">
								<table>
									<tr>
										<td valign="middle">
											<span class="field-name mb10" style="width:90px">可使用金额:</span>
										</td>
										<td valign="middle" class="modaltd">
										<rich:panel id="canUseMoneyPanl" style="margin:0; border:none; padding: 0;">
											<input id="canUseMoney" value="#{expendApplyInfoHome.canUseMoney}" class=" mb10 border" style="height:34px;width:159px;"  readonly="readonly"/>
										</rich:panel>
										</td>
									</tr>
								</table>
							</div>
						</td>
					</tr>
				</table>
		    </div>
		    <div class="modal-footer">
		       	<button type="button" class="btn btn-primary" onclick="return toAddProject()">确定</button>
		        <button type="button" class="btn btn-default" data-dismiss="modal">返回</button>
		    </div>
		</div>
		</div>
		</div>
		<a:form>
			<a:queue requestDelay="100" ignoreDupResponses="true" />
			<a:jsFunction name="selectProject" action="#{expendApplyInfoHome.selectProject}" reRender="totalMoneyPanl,usedMoneyPanl,canUseMoneyPanl,contractPanl"  data="#{expendApplyInfoHome.contractJson}" oncomplete="changeProjectComplete(data)">
				<a:actionparam name="projectId" assignTo="#{expendApplyInfoHome.projectId}" />
				<a:actionparam name="projectType" assignTo="#{expendApplyInfoHome.projectType}" />
				<a:actionparam name="departmentId" assignTo="#{expendApplyInfoHome.departmentId}" />
				<a:actionparam name="fundsSourceId" assignTo="#{expendApplyInfoHome.fundsSourceId}" />
			</a:jsFunction>
			<a:jsFunction name="save" action="#{expendApplyInfoHome.save}" data="#{expendApplyInfoHome.saveResult}" oncomplete="saveComplete(data)"  reRender="formnum">
				<a:actionparam name="year" assignTo="#{expendApplyInfoHome.year}" />
				<a:actionparam name="applyUser" assignTo="#{expendApplyInfoHome.applyUser}" />
				<a:actionparam name="applySn" assignTo="#{expendApplyInfoHome.applySn}" />
				<a:actionparam name="reciveCompany" assignTo="#{expendApplyInfoHome.reciveCompany}" />
				<a:actionparam name="invoiceSn" assignTo="#{expendApplyInfoHome.invoiceSn}" />
				<a:actionparam name="summary" assignTo="#{expendApplyInfoHome.summary}" />
				<a:actionparam name="reimbur" assignTo="#{expendApplyInfoHome.reimbur}" />
				<a:actionparam name="projectJson" assignTo="#{expendApplyInfoHome.projectJson}" />
				<a:actionparam name="applyTime" assignTo="#{expendApplyInfoHome.applyTime}" />
				<a:actionparam name="registTime" assignTo="#{expendApplyInfoHome.registTime}" />
				<a:actionparam name="register" assignTo="#{expendApplyInfoHome.register}" />
				<a:actionparam name="comment" assignTo="#{expendApplyInfoHome.comment}" />
			</a:jsFunction>
			<a:jsFunction name="update" action="#{expendApplyInfoHome.update}" data="#{expendApplyInfoHome.saveResult}" oncomplete="saveComplete(data)">
				<a:actionparam name="expendApplyInfoId" assignTo="#{expendApplyInfoHome.expendApplyInfoId}" />
				<a:actionparam name="year" assignTo="#{expendApplyInfoHome.year}" />
				<a:actionparam name="applyUser" assignTo="#{expendApplyInfoHome.applyUser}" />
				<a:actionparam name="applySn" assignTo="#{expendApplyInfoHome.applySn}" />
				<a:actionparam name="reciveCompany" assignTo="#{expendApplyInfoHome.reciveCompany}" />
				<a:actionparam name="invoiceSn" assignTo="#{expendApplyInfoHome.invoiceSn}" />
				<a:actionparam name="summary" assignTo="#{expendApplyInfoHome.summary}" />
				<a:actionparam name="reimbur" assignTo="#{expendApplyInfoHome.reimbur}" />
				<a:actionparam name="projectJson" assignTo="#{expendApplyInfoHome.projectJson}" />
				<a:actionparam name="applyTime" assignTo="#{expendApplyInfoHome.applyTime}" />
				<a:actionparam name="registTime" assignTo="#{expendApplyInfoHome.registTime}" />
				<a:actionparam name="register" assignTo="#{expendApplyInfoHome.register}" />
				<a:actionparam name="comment" assignTo="#{expendApplyInfoHome.comment}" />
			</a:jsFunction>
			<a:jsFunction name="clearList" action="#{expendApplyInfoHome.clearList}" reRender="listPanl" oncomplete="changeProjectComplete(0)">
			</a:jsFunction>
			<a:jsFunction name="selectDepart" action="#{expendApplyInfoHome.selectDepart}" reRender="departPanl,fundsSourcePanl,projectPanl,totalMoneyPanl,usedMoneyPanl,canUseMoneyPanl" oncomplete="huidiao()">
				<a:actionparam name="departmentId" assignTo="#{expendApplyInfoHome.departmentId}" />
				<a:actionparam name="fundsSourceId" assignTo="#{expendApplyInfoHome.fundsSourceId}" />
				<a:actionparam name="projectId" assignTo="#{expendApplyInfoHome.projectId}" />
				<a:actionparam name="projectType" assignTo="#{expendApplyInfoHome.projectType}" />
			</a:jsFunction>
			<a:jsFunction name="selectFoundsSource" action="#{expendApplyInfoHome.selectFoundsSource}" reRender="departPanl,fundsSourcePanl,projectPanl,totalMoneyPanl,usedMoneyPanl,canUseMoneyPanl" oncomplete="huidiao()">
				<a:actionparam name="departmentId" assignTo="#{expendApplyInfoHome.departmentId}" />
				<a:actionparam name="fundsSourceId" assignTo="#{expendApplyInfoHome.fundsSourceId}" />
				<a:actionparam name="projectId" assignTo="#{expendApplyInfoHome.projectId}" />
				<a:actionparam name="projectType" assignTo="#{expendApplyInfoHome.projectType}" />
			</a:jsFunction>
			<a:jsFunction name="modalInit" action="#{expendApplyInfoHome.modalInit}" reRender="departPanl,fundsSourcePanl,projectPanl,totalMoneyPanl,usedMoneyPanl,canUseMoneyPanl,projectTypeSel" oncomplete="toAddModelComplete()">
				<a:actionparam name="year" assignTo="#{expendApplyInfoHome.year}" />
			</a:jsFunction>
			<a:jsFunction name="addProject" action="#{expendApplyInfoHome.addProject}" reRender="listPanl" oncomplete="addProjectComplete()">
				<a:actionparam name="projectId" assignTo="#{expendApplyInfoHome.projectId}" />
				<a:actionparam name="projectType" assignTo="#{expendApplyInfoHome.projectType}" />
				<a:actionparam name="projectJson" assignTo="#{expendApplyInfoHome.projectJson}" />
			</a:jsFunction>
		</a:form>
		<script type="text/javascript" src="#{request.contextPath}/common/js/bootstrap.min.js" />
		<script type="text/javascript" src="#{request.contextPath}/common/js/bootstrap-datetimepicker.min.js" charset="UTF-8" />
		<script type="text/javascript" src="#{request.contextPath}/common/js/bootstrap-datetimepicker.zh-CN.js" charset="UTF-8" />
		<script type="text/javascript" src="#{request.contextPath}/common/js/bootstrap-select-defaults-zh_CN.min.js" charset="UTF-8" />
		<script type="text/javascript" src="#{request.contextPath}/common/js/bootstrap-select.min.js" charset="UTF-8" />
		<script type="text/javascript" src="#{request.contextPath}/icheck/js/icheck.min.js" charset="UTF-8" />
		<script type="text/javascript" src="#{request.contextPath}/sg-fileupload/js/kernel.js" />
		<script type="text/javascript" src="#{request.contextPath}/toolkit/utils.js" />
		<script type="text/javascript">
		//<![CDATA[
			jQuery(document).ready(function() {
				
				//时间插件
				jQuery(".form_datetime_second").datetimepicker({
					format: "yyyy-mm-dd",  
					autoclose: true,
					weekStart: 1,
					language:  'zh-CN',
					startView: 2,
					minView: 2,
					maxView: 2,	
					forceParse: false, 
					pickerPosition: "bottom-left"
				});
				jQuery('.selectpicker').selectpicker();
				var applyUser = "#{expendApplyInfoHome.applyUser}";
				var applayer = "#{expendApplyInfoHome.reimbur}";
				var register = "#{expendApplyInfoHome.register}";
				var expendIdEdit = jQuery("#mainForm\\:expendApplyIdEdit").val();
				if(expendIdEdit != "0"){
					jQuery("#user").selectpicker("val",applyUser);
					if(register != "0"){
						jQuery("#register").selectpicker("val",register);
					}else{
						jQuery('#register').selectpicker({noneSelectedText:"全部"});
						jQuery('#register').selectpicker('deselectAll');
					}
					jQuery('.opr-attachment').click(function() {
						showLayer();
						var tempHandler = jQuery(this);// 临时句柄
						if (jQuery(this).hasClass('activated')) {
							setTimeout(function() {
								hideLayer();
							}, 512);// 防止恶意点击
						} else {
							sgFileupload['reinstall']({
							    'target' :jQuery(this).attr('id'),
							    'alias' : jQuery(this).parents('.expendtr').find('.project_name').html(),
							    'source' : jQuery(this).attr('fu-source') == undefined ? "" : jQuery(this).attr('fu-source'),
							    'class' : 'sg-fu-custom--attachment',
							    'completed' : function() {
								    tempHandler.addClass('activated');
								    tempHandler.click();
							    }
							}); // 重新安装附件插件
						}
					});
				}
				//初始化部分数据
				var userId = #{sessionToken.userInfoId};
				if(userId){
					jQuery('#user').val(userId);
					jQuery('#user').selectpicker("render");
					jQuery('#register').val(userId);
					jQuery('#register').selectpicker("render");
				}
				jQuery('#mainForm\\:reimbur').val('#{sessionToken.fullname}');

				jQuery("#mainForm\\:formnum").attr("readonly",true);
				 jQuery('.selectpicker').selectpicker();
				 keyInit();

				 
			});
			
			//选择项目
			function changeProject(){
				var depart = jQuery("#depart").val();
				var fundsSource = jQuery("#fundsSource").val();
				var projectId = jQuery("#projectId").val();
				var projectType = jQuery("#projectType").val();
				selectProject(projectId,projectType,depart,fundsSource);
			}
			//选择项目回调
			function changeProjectComplete(data){
				jQuery(".form_datetime_second").datetimepicker({
					format: "yyyy-mm-dd",  
					autoclose: true,
					weekStart: 1,
					language:  'zh-CN',
					startView: 2,
					minView: 2,
					maxView: 2,	
					forceParse: false, 	
					pickerPosition: "bottom-left"
				});
				huidiao();
				if(data.is_audit){
					jQuery("#contractSel").selectpicker("val",data.contract_id);
					jQuery(".contractTr").show();
				}else{
					jQuery(".contractTr").hide();
				}
			}

			//提交校验
			function checkSub(){
				showLayer();
				var year = jQuery("#budgetYear").val();
				var user = jQuery("#user").val();
				var applySn = jQuery("#mainForm\\:formnum").val();
				var reciveCompany = jQuery("#reciveCompany").val();
				var invoicenum = jQuery("#mainForm\\:invoicenum").val();
				var summary = jQuery("#mainForm\\:summary").val();
				var reimbursementer = jQuery("#mainForm\\:reimbur").val();
				var applyTime = jQuery("#applyTime").val();
				var registeTime = jQuery("#registeTime").val();
				var register = jQuery("#register").val();
				var comment = jQuery("#mainForm\\:comment").val();
				if(register == undefined){
					register == -1;
				}
				var flag = true;
				if(year == null){
					hideLayer();
					___msg('温馨提示', "请选择预算年份");
					flag = false;
					return ;
				}
				if(user == null || user == "" || projectId == "-1"){
					hideLayer();
					___msg('温馨提示', "请选择申请人");
					flag = false;
					return ;
				}
				if(applySn == ""){
					hideLayer();
					___msg('温馨提示', "请输入单据编号");
					flag = false;
					return ;
					
				}
				if(reciveCompany == "" || reciveCompany == "报销论文版面费请添加科室+杂志名称"){
					hideLayer();
					___msg('温馨提示', "请输入收款公司");
					flag = false;
					return ;
				}
				 if(invoicenum.length > 500){
					 hideLayer();
					___msg('温馨提示', "发票号最多500字");
					flag = false;
					return ;
				}
				 /*if(summary == "" ){
					___msg('温馨提示', "请输入发票张数");
					flag = false;
					return ;
				}else{
					if(isNaN(summary) || Number(summary) < 1 || Number(summary) % 1 != 0){
						___msg('温馨提示', "发票张数只能为整数");
						flag = false;
						return ;
					}
				} */
				if(applyTime == ""){
					hideLayer();
					___msg('温馨提示', "请选择申请时间");
					flag = false;
					return ;
				}
				if(null == reimbursementer || reimbursementer == ""){
					hideLayer();
					___msg('温馨提示', "请输入报销人");
					flag = false;
					return ;
				}
				jQuery("input[name='money']").each(function(){
					var price = jQuery(this).val();
					if(price =="" ||  isNaN(price)){
						hideLayer();
						___msg('温馨提示', "请输入支出金额");
						flag = false;
						return;
						if(parseFloat(price) < 0 || parseFloat(price) == 0){
							hideLayer();
							___msg('温馨提示', "请输入正确的数字");
							flag = false;
							return ;
						}
					}else{
						if(parseFloat(price) > parseFloat(jQuery(this).parent().parent().find("td[name='canUseMoney']").text())){
							hideLayer();
							___msg('温馨提示', "支出金额不能大于可支出金额");
							flag = false;
							return;
						}
					}
				});
				var json = getJson();
				if(json == '{"expend_list":[]}'){
					hideLayer();
					___msg('温馨提示', "请选择申请内容");
					flag = false;
					return;
				}
				if(comment != "" && comment.length >200){
					hideLayer();
					___msg('温馨提示', "备注不能大于200字");
					flag = false;
					return;
				}
				if(flag){
					save(year,user,applySn,reciveCompany,invoicenum,summary,reimbursementer,json,applyTime,registeTime,register,comment);
				}
				
			}

			//保存回调
			function saveComplete(data){
				hideLayer();
				if (data != null && 'INVOKE_SUCCESS' == data.invoke_result) {
				    ___dynamic_function = function() {
				    	window.location.href = '../budget/ExpendApplayList.seam';
					};
					___msg('温馨提示', data.message, {closed: ___dynamic_function});
				} else {
					___msg('温馨提示', data.message);
				}
			}

			//提交校验
			function checkEdit(){
				showLayer();
				var expendInfoId = jQuery("#mainForm\\:expendApplyIdEdit").val();
				var year = jQuery("#budgetYear").val();
				var user = jQuery("#user").val();
				var applySn = jQuery("#mainForm\\:formnum").val();
				var reciveCompany = jQuery("#reciveCompany").val();
				var invoicenum = jQuery("#mainForm\\:invoicenum").val();
				var summary = jQuery("#mainForm\\:summary").val();
				var reimbursementer = jQuery("#mainForm\\:reimbur").val();
				var applyTime = jQuery("#applyTime").val();
				var registeTime = jQuery("#registeTime").val();
				var register = jQuery("#register").val();
				var comment = jQuery("#mainForm\\:comment").val();
				var flag = true;
				if(year == null){
					hideLayer();
					___msg('温馨提示', "请选择预算年份");
					flag = false;
					return ;
				}
				if(user == null || user == "" || projectId == "-1"){
					hideLayer();
					___msg('温馨提示', "请选择报销人");
					flag = false;
					return ;
				}
				if(applySn == ""){
					hideLayer();
					___msg('温馨提示', "请输入单据编号");
					flag = false;
					return ;
					
				}
				if(reciveCompany == ""){
					hideLayer();
					___msg('温馨提示', "请输入收款公司");
					flag = false;
					return ;
				}

				if(register == null || register == "" || register == "-1"){
					hideLayer();
					___msg('温馨提示', "请选择登记人");
					flag = false;
					return ;
				}
				if(invoicenum.length > 500){
					hideLayer();
					___msg('温馨提示', "发票号最多500字");
					flag = false;
					return ;
				}
				/* if(invoicenum == ""){
					___msg('温馨提示', "请输入发票号");
					flag = false;
					return ;
				}
				if(summary == ""){
					___msg('温馨提示', "请输入发票张数");
					flag = false;
					return ;
				}else{
					if(isNaN(summary) || Number(summary) < 1 || Number(summary) % 1 != 0){
						___msg('温馨提示', "发票张数只能为整数");
						flag = false;
						return ;
					}
				} */
				if(applyTime == ""){
					hideLayer();
					___msg('温馨提示', "请选择申请时间");
					flag = false;
					return ;
				}
				if(null == reimbursementer || reimbursementer == ""){
					hideLayer();
					___msg('温馨提示', "请输入报销人");
					flag = false;
					return ;
				}
				jQuery("input[name='money']").each(function(){
					var price = jQuery(this).val();
					if(price =="" ||  isNaN(price)){
						hideLayer();
						___msg('温馨提示', "请输入支出金额");
						flag = false;
						return;
						if(parseFloat(price) < 0 || parseFloat(price) == 0){
							hideLayer();
							___msg('温馨提示', "请输入正确的数字");
							flag = false;
							return ;
						}
					}else{
						if(parseFloat(price) > parseFloat(jQuery(this).parent().parent().find("td[name='canUseMoney']").text())){
							hideLayer();
							___msg('温馨提示', "支出金额不能大于可支出金额");
							flag = false;
							return;
						}
					}
				});
				var json = getJson();
				if(json == '{"expend_list":[]}'){
					hideLayer();
					___msg('温馨提示', "请选择申请内容");
					flag = false;
					return;
				}
				if(comment != "" && comment.length >200){
					hideLayer();
					___msg('温馨提示', "备注不能大于200字");
					flag = false;
					return;
				}
				if(flag){
					update(expendInfoId,year,user,applySn,reciveCompany,invoicenum,summary,reimbursementer,json,applyTime,registeTime,register,comment);
				}
				
				
			}
			//获取列表json
			function getJson(){
				var json = '{"expend_list":[';
				jQuery(".expendtr").each(function(i){
					var projectId= jQuery("#project_id_" + i).text();
					var projectType = jQuery("#project_type_" + i).text().trim();
					var projectFrozen = jQuery("#projectFrozen_" + i).text().trim();
					var projectSurplus = jQuery("#canUseMoney_" + i).text().trim();
					var attachment = sgFileupload['getSource'](jQuery(this).find('.opr-attachment').attr('id'));
					var nepiId= jQuery("#nepi_id_" + i).text().trim();
					var money = jQuery("#money_" + i).val().trim();
					json += '{"project_id":"' + projectId + '",';
					json += '"project_type":"' + projectType + '",';
					json += '"frozen_money":"' + projectFrozen + '",';
					json += '"project_surplus":"' + projectSurplus + '",';
					json += '"attachment":"' + attachment + '",';
					json += '"nepiId":"' + nepiId + '",';
					json += '"expend_money":"' + money + '"},';
				});
				if(json == '{"expend_list":['){
					json = '{"expend_list":[]}';
				}else{
					json = json.substring(0,json.length-1);
					json += "]}"; 
				}
				
				return json;
			}

			//删除列表
			function deleteList(){
				clearList();
			}

			//部门选择事件
			function departChange(){
				var depart = jQuery("#depart").val();
				var fundsSource = jQuery("#fundsSource").val();
				var projectId = jQuery("#projectId").val();
				var projectType = jQuery("#projectType").val();
				selectDepart(depart,fundsSource,projectId,projectType);
			}
			//回调初始化下拉列表
			function huidiao(){
				jQuery('.selectpicker').selectpicker();
			}
			//添加初始化下拉列表
			function toAddModel(){
				var year = jQuery("#budgetYear").val();
				modalInit(year);
			}
			function toAddModelComplete(){
				var deptId = "#{sessionToken.departmentInfoId}";
				if(deptId){
					jQuery('#depart').val(deptId);
					jQuery('#depart').selectpicker("render");
				}
				jQuery("#addModal").modal("show");
				huidiao();
			}
			//添加项目
			function toAddProject(){
				var projectId = jQuery("#projectId").val();
				var projectType = jQuery("#projectType").val();
				var contractId = jQuery("#contractSel").val();
				if(jQuery(".contractTr").is(":visible") && !contractId){
					___msg('温馨提示', "审计项目请选择一个合同！");
					flag = false;
					return;
				} 
				var json = getJson();
				addProject(projectId,projectType,json);
			}
			function addProjectComplete(){
				jQuery(".form_datetime_second").datetimepicker({
					format: "yyyy-mm-dd",  
					autoclose: true,
					weekStart: 1,
					language:  'zh-CN',
					startView: 2,
					minView: 2,
					maxView: 2,	
					forceParse: false, 	
					pickerPosition: "bottom-left"
				});
				jQuery("#addModal").modal("hide");
				huidiao();
				jQuery('.opr-attachment').click(function() {
					showLayer();
					var tempHandler = jQuery(this);// 临时句柄
					if (jQuery(this).hasClass('activated')) {
						setTimeout(function() {
							hideLayer();
						}, 512);// 防止恶意点击
					} else {
						sgFileupload['reinstall']({
						    'target' :jQuery(this).attr('id'),
						    'alias' : jQuery(this).parents('.expendtr').find('.project_name').html(),
						    'source' : jQuery(this).attr('fu-source') == undefined ? "" : jQuery(this).attr('fu-source'),
						    'class' : 'sg-fu-custom--attachment',
						    'completed' : function() {
							    tempHandler.addClass('activated');
							    tempHandler.click();
						    }
						}); // 重新安装附件插件
					}
				});
			}

			function fundsSource(){
				var depart = jQuery("#depart").val();
				var fundsSource = jQuery("#fundsSource").val();
				var projectId = jQuery("#projectId").val();
				var projectType = jQuery("#projectType").val();
				selectFoundsSource(depart,fundsSource,projectId,projectType);
			}
			function totalMoney(){
				var total = 0;
				jQuery("input[name='money']").each(function(){
					var price = jQuery(this).val();
					if(price == ""){
						price = "0";
					}
					if(isNaN(price)){
						___msg('温馨提示', "请输入正确的支出金额");
						flag = false;
						return;
						if(parseFloat(price) < 0 || parseFloat(price) == 0){
							___msg('温馨提示', "请输入正确的支出金额");
							flag = false;
							return ;
						}
					}else{
						if(parseFloat(price) > parseFloat(jQuery(this).parent().parent().find("td[name='canUseMoney']").text())){
							___msg('温馨提示', "支出金额不能大于可支出金额");
							flag = false;
							return;
						}
					}
					total += parseFloat(price);
				});
				jQuery("#mainForm\\:allMoney").val(total);
			}


			//输入框级联查询功能
			function searchLi(obj,event,num){
				var code=event.keyCode;
				var inVal = jQuery.trim(jQuery(obj).val());
				if(code!=40 && code!=38 && code != 108 && code != 13){
					var val="";
					jQuery(obj).next().find(".mater_name_list").empty();
					jQuery(obj).next().find(".mater_name_list3 li").each(function(i){
						var liTextVal=jQuery(this).text().replace(jQuery(this).find(":first").text(),"");
						if(inVal!=""){
							if(liTextVal.indexOf(inVal)>=0){
								val +="<li  onclick='selectCompany(this)' calss='material_li material_li_"+(i+1)+"'>";
								val +=jQuery(this).html();
								val +="</li>";
							}
						}else{
							jQuery(obj).parent().find('div.mater_name_bd').hide();
						}
						/* else{
							val +="<li  onclick='selectCompany(this)' calss='material_li material_li_"+(i+1)+"' >";
							val +=jQuery(this).html();
							val +="</li>";
						} */
						
					});
					if(val != ""){
						jQuery(obj).next().find(".mater_name_list").append(val);
						jQuery(obj).parent().find('div.mater_name_bd').show();
					} else{
						jQuery(obj).parent().find('div.mater_name_bd').hide();
					}
					
				}else if((code==40 || code==38) && num==2){
					var val="";
					jQuery(obj).next().find(".mater_name_list").empty();
					jQuery(obj).next().find(".mater_name_list3 li").each(function(i){
						var liTextVal=jQuery(this).text().replace(jQuery(this).find(":first").text(),"");
						if(inVal!=""){
							if(liTextVal.indexOf(inVal)>=0){
								val +="<li  onclick='selectCompany(this)' calss='material_li material_li_"+(i+1)+"'>";
								val +=jQuery(this).html();
								val +="</li>";
							}
						}else{
							val +="<li  onclick='selectCompany(this)' calss='material_li material_li_"+(i+1)+"'>";
							val +=jQuery(this).html();
							val +="</li>";
						}
						
					});
					jQuery(obj).next().find(".mater_name_list").append(val);
					jQuery(obj).parent().find('div.mater_name_bd').show();
			}
			}
			function searchDis(obj){
				 setTimeout(function(){
					 jQuery(obj).parent().find('div.mater_name_bd').hide();
		            },500)  
				
			}
			function searchShow(obj){
				jQuery(obj).parent().find('div.mater_name_bd').show();
			}

			function selectCompany(obj){
				jQuery("#reciveCompany").val(jQuery(obj).html());
				jQuery('div.mater_name_bd').hide();
			}

			//页面初始化键盘上下键操作
			function keyInit(){
				 jQuery("#reciveCompany").keydown(function(e){
				        e = e || window.event;
				        var keycode = e.which ? e.which : e.keyCode;
				        if(keycode == 38){
				            movePrev(this);
				        }else if(keycode == 40){
				            if(!jQuery(this).parent().find(".mater_name_bd").is(":visible")){
				            	jQuery(this).parent().find(".mater_name_bd").show();
				            	searchLi(this,e,2);
				                return;
				            }
				            if(jQuery(this).next().find("li").hasClass("addbg")){
				                moveNext(this);
				            }else{
				            	jQuery(this).next().find("li").removeClass('addbg').eq(0).addClass('addbg');
				            }
				        }else if(keycode == 108 || keycode == 13){
				            dojob(this,keycode);
				        }
				    });
			}
			//键盘方向键↓操作
			var movePrev = function(obj){
				var index = jQuery(".mater_name_list").find(".addbg").prevAll().length;
			    if(index == 0){
			    	 jQuery(".mater_name_list").find("li").removeClass('addbg').eq(jQuery(".material_li").length-1).addClass('addbg');
			    }else{
			    	 jQuery(".mater_name_list").find("li").removeClass('addbg').eq(index-1).addClass('addbg');
			    }
			    jQuery(".mater_name_list").scrollTop((index-1)*24);
			};
			//键盘方向键↑操作
			var moveNext = function(obj){
			    var index = jQuery(".mater_name_list").find(".addbg").prevAll().length;
			    if(index == jQuery(".mater_name_list").find(".material_li").length-1){
			    	 jQuery(".mater_name_list").find("li").removeClass('addbg').eq(0).addClass('addbg');
			    }else{
			    	jQuery(".mater_name_list").find("li").removeClass('addbg').eq(index+1).addClass('addbg');
			    }
			    jQuery(".mater_name_list").scrollTop((index-1)*24);
			};
			
			var dojob = function(obj,code){
			    //判断当前是否存在选中的下拉数据，如果有则执行选中数据的点击事件，没有则在根据扫码功能是否开启来判断是否走扫码功能
				if( jQuery(".mater_name_list").find("li").hasClass("addbg")){
					 jQuery(".mater_name_list").find(".addbg").click();
			    }
			}


			function companyBlur(){
				var company = jQuery("#reciveCompany").val().trim();
				if(company == ""){
					jQuery("#mainForm\\:reciveCompany").val("报销论文版面费请添加科室+杂志名称");
				}
			}
			function companyFous(){
				var company = jQuery("#reciveCompany").val().trim();
				if(company == "报销论文版面费请添加科室+杂志名称"){
					jQuery("#mainForm\\:reciveCompany").val("");
				}
			}
		//]]>
		</script>
	</ui:define>

</ui:composition>
